#!/bin/bash
# User data script to be used in conjunction with an AWS EC2 instance and Amazon Linux AMI to launch a fully functional web based wiki system. 

# Initial system update
yum update -y

# Install packages
yum install -y php php-xml php-gd wget php-fpm

# Installing and starting Nginx  
yum install -y nginx
systemctl start nginx
systemctl enable nginx

# Download Docuwiki
cd /tmp
wget https://download.dokuwiki.org/src/dokuwiki/dokuwiki-stable.tgz

# Extract Docuwiki
tar -xzf dokuwiki-stable.tgz

# Clear web root and move Docuwiki files
rm -rf /usr/share/nginx/html/*

***

# Set proper ownership first
chown -R nginx:nginx /usr/share/nginx/html/

# Create required data directories with proper permissions
mkdir -p /usr/share/nginx/html/data/{pages,meta,media,cache,index,locks,tmp,attic}
mkdir -p /usr/share/nginx/html/conf

# Set proper permissions
chown -R nginx:nginx /usr/share/nginx/html/
chmod -R 755 /usr/share/nginx/html/
chmod -R 777 /usr/share/nginx/html/data/
chmod -R 777 /usr/share/nginx/html/conf/

# Configure Nginx for PHP (official Docuwiki example)
cat > /etc/nginx/conf.d/dokuwiki.conf << 'EOF'
 
# PHP Handler
upstream php-handler {
    server unix:/run/php-fpm/www.sock;        # Correct path for Amazon Linux
}
 
# Actual configuration
server {
 
# BASICS 
    server_name default_server;     # optional: your domain name
    root        /usr/share/nginx/html;
    index       doku.php;
 
# NoSSL version 
    listen           80;            # IPv4
    listen      [::]:80;            # IPv6
 
# HEADERS 
    # Information "leaks"
    server_tokens       off;
    fastcgi_hide_header X-Powered_by;
 
# TWEAKS 
 
    client_max_body_size 4M;          # Maximum file upload size
    client_body_buffer_size 128k;
 
    location ~ ^/lib.*\.(js|css|gif|png|ico|jpg|jpeg|svg)$ {
        expires 365d;   # browser caching
    }
 
 
# RESTRICT ACCESS ######### ######### ######### ######### ######### ######### ##
    # Reference: https://www.dokuwiki.org/security#deny_directory_access_in_nginx
                 # TODO: Compare with this
 
 
    # Comment out while installing, then uncomment after setup
    # location ~ /(install.php) { deny all; }

    # After setup is complete, uncomment the install.php deny rule in /etc/nginx/conf.d/dokuwiki.conf
 
 
    # .ht             - .htaccess, .htpasswd, .htdigest, .htanything
    # .git, .hg, .svn - Git, Mercurial, Subversion.
    # .vs             - Visual Studio (Code)
    # All directories except lib.
    # All "other" files that you don't want to delete, but don't want public.
 
    location ~ /(\.ht|\.git|\.hg|\.svn|\.vs|data|conf|bin|inc|vendor|README|VERSION|SECURITY.md|COPYING|composer.json|composer.lock) {
        #return 404; # https://www.dokuwiki.org/install:nginx?rev=1734102057#nginx_particulars
        deny all;    # Returns 403
    }
 
 
# REDIRECT & PHP    
 
    location / {
        try_files $uri $uri/ @dokuwiki;
 
        # This means; where $uri is 'path', if 'GET /path' doesnt exist, redirect
        # client to 'GET /path/' directory. If neither, goto @dokuwiki rules.
    }
 
    location @dokuwiki {
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1&$args last;
 
        # rewrites "doku.php/" out of the URLs if you set the userewrite
        # setting to .htaccess in dokuwiki config page
    }
 
    location ~ \.php$ {
        try_files $uri $uri/ /doku.php;
 
        include       fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REDIRECT_STATUS 200;
        # fastcgi_param HTTPS on;     # optional ?! TODO
 
        fastcgi_pass php-handler;
    }
}
EOF

# Remove default nginx config
rm -f /etc/nginx/conf.d/default.conf

# Start and enable php-fpm
systemctl start php-fpm
systemctl enable php-fpm

# Final permission check and restart services
chown -R nginx:nginx /usr/share/nginx/html/
systemctl restart nginx
systemctl restart php-fpm


